<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI故事生成器API测试 - 吉卜力风格</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Noto+Sans+SC:wght@300;400;500&display=swap');

        :root {
            --bg-color: #FDF8E8; /* 米白画纸 */
            --card-bg-color: #FFFFFF;
            --primary-color: #7B9A8E; /* 森林绿 */
            --text-color: #5A524C; /* 深棕色 */
            --input-bg-color: #F9F6F0; /* 输入框背景 */
            --border-color: #D8D0C1; /* 柔和边框色 */
            --shadow-color: rgba(90, 82, 76, 0.15);
            --success-color: #D4EDDA; /* 成功提示背景 */
            --success-text: #155724; /* 成功提示文字 */
            --error-color: #F8D7DA; /* 错误提示背景 */
            --error-text: #721c24; /* 错误提示文字 */
            --loading-color: #D1ECF1; /* 加载提示背景 */
            --loading-text: #0c5460; /* 加载提示文字 */

            --font-heading: 'Caveat', cursive;
            --font-body: 'Noto Sans SC', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--bg-color);
            padding: 20px;
            color: var(--text-color);
            /* Subtle paper texture */
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cpattern id='dot-texture' patternUnits='userSpaceOnUse' width='5' height='5'%3E%3Ccircle cx='2.5' cy='2.5' r='0.5' fill='%23000' fill-opacity='0.01'/%3E%3C/pattern%3E%3Crect width='100%25' height='100%25' fill='url(%23dot-texture)'/%3E%3C/svg%3E");
            background-repeat: repeat;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg-color);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px var(--shadow-color);
            position: relative; /* For corner decorations */
            overflow: hidden;
        }

        /* Corner decorations */
        .corner-decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            opacity: 0.6;
            pointer-events: none;
            z-index: 0;
        }
        .top-left {
            top: -10px;
            left: -10px;
            transform: rotate(0deg);
        }
        .bottom-right {
            bottom: -10px;
            right: -10px;
            transform: rotate(180deg);
        }

        h1 {
            font-family: var(--font-heading);
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 15px;
            background: var(--input-bg-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            font-family: var(--font-heading);
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 1.05rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(123, 154, 142, 0.2);
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .file-input {
            margin: 10px 0;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #6a8a7c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background: #c7bfae;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .success {
            background: var(--success-color);
            color: var(--success-text);
            border: 1px solid #c3e6cb;
        }

        .error {
            background: var(--error-color);
            color: var(--error-text);
            border: 1px solid #f5c6cb;
        }

        .loading {
            background: var(--loading-color);
            color: var(--loading-text);
            border: 1px solid #bee5eb;
        }

        .response {
            margin-top: 25px;
            padding: 20px;
            background: var(--input-bg-color);
            border-radius: 15px;
            display: none;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .json-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #4a5568;
        }

        .story-output {
            background: var(--card-bg-color);
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.7;
        }

        .image-preview, .generated-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .tab:hover {
            background-color: var(--input-bg-color);
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .decorative-divider {
            margin: 20px 0;
            text-align: center;
        }
        .decorative-divider svg {
            width: 100%;
            max-width: 300px; /* Limit width for the divider */
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Corner decorations -->
        <svg class="corner-decoration top-left" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <path d="M 10 90 Q 30 70, 50 80 T 90 60" stroke="#7B9A8E" fill="none" stroke-width="2" stroke-linecap="round"/>
            <path d="M 25 85 Q 20 75, 30 70 Q 40 75, 35 85 Z" fill="#7B9A8E" opacity="0.7"/>
            <path d="M 40 75 Q 35 65, 45 60 Q 55 65, 50 75 Z" fill="#7B9A8E" opacity="0.7"/>
            <path d="M 60 65 Q 55 55, 65 50 Q 75 55, 70 65 Z" fill="#7B9A8E" opacity="0.7"/>
        </svg>
         <svg class="corner-decoration bottom-right" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <path d="M 10 90 Q 30 70, 50 80 T 90 60" stroke="#7B9A8E" fill="none" stroke-width="2" stroke-linecap="round"/>
            <path d="M 25 85 Q 20 75, 30 70 Q 40 75, 35 85 Z" fill="#7B9A8E" opacity="0.7"/>
            <path d="M 40 75 Q 35 65, 45 60 Q 55 65, 50 75 Z" fill="#7B9A8E" opacity="0.7"/>
            <path d="M 60 65 Q 55 55, 65 50 Q 75 55, 70 65 Z" fill="#7B9A8E" opacity="0.7"/>
        </svg>

        <h1>AI故事生成器API测试</h1>
        
        <!-- API端点选择 -->
        <div class="section">
            <div class="tabs">
                <div class="tab active" onclick="switchEndpoint('picture')">生成故事+配图</div>
                <div class="tab" onclick="switchEndpoint('text')">仅生成文本</div>
            </div>

            <div class="decorative-divider">
                <svg width="100%" height="20" viewBox="0 0 100 20" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="0" y1="10" x2="40" y2="10" stroke="#D8D0C1" stroke-width="1"/>
                    <path d="M 45 10 Q 47 5, 50 5 T 55 10 Q 53 15, 50 15 T 45 10 Z" fill="#7B9A8E" opacity="0.8"/>
                    <line x1="60" y1="10" x2="100" y2="10" stroke="#D8D0C1" stroke-width="1"/>
                </svg>
            </div>

            <!-- 生成故事+配图 -->
            <div id="endpoint-picture" class="tab-content active">
                <h2>/api/generate-picture - 生成完整故事和配图</h2>
                
                <div class="form-group">
                    <label>API地址:</label>
                    <input type="text" id="api-url-picture" value="https://search.tj15982183241.workers.dev/api/generate-picture">
                </div>

                <div class="form-group">
                    <label>文本提示 (可选):</label>
                    <textarea id="prompt-picture" placeholder="例如：给我讲一个关于小狗在森林里探险的故事"></textarea>
                </div>

                <div class="form-group">
                    <label>上传图片 (可选):</label>
                    <input type="file" id="image-picture" accept="image/*" class="file-input">
                    <img id="preview-picture" class="image-preview" style="display: none;">
                </div>

                <div class="form-group">
                    <label>语言:</label>
                    <select id="language-picture">
                        <option value="zh">中文</option>
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>会话ID (可选):</label>
                    <input type="text" id="session-picture" placeholder="留空创建新会话">
                </div>

                <button class="btn btn-primary" onclick="testGeneratePicture()">测试生成故事+配图</button>
                <button class="btn btn-secondary" onclick="clearForm('picture')">清空</button>

                <div id="message-picture" class="message"></div>
                <div id="response-picture" class="response"></div>
            </div>

            <!-- 仅生成文本 -->
            <div id="endpoint-text" class="tab-content">
                <h2>/api/generate-text - 仅生成故事文本和图片提示词</h2>
                
                <div class="form-group">
                    <label>API地址:</label>
                    <input type="text" id="api-url-text" value="https://search.tj15982183241.workers.dev/api/generate-text">
                </div>

                <div class="form-group">
                    <label>文本提示 (可选):</label>
                    <textarea id="prompt-text" placeholder="例如：给我讲一个关于小狐狸探险的故事"></textarea>
                </div>

                <div class="form-group">
                    <label>上传图片 (可选):</label>
                    <input type="file" id="image-text" accept="image/*" class="file-input">
                    <img id="preview-text" class="image-preview" style="display: none;">
                </div>

                <div class="form-group">
                    <label>语言:</label>
                    <select id="language-text">
                        <option value="zh">中文</option>
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>会话ID (可选):</label>
                    <input type="text" id="session-text" placeholder="留空创建新会话">
                </div>

                <button class="btn btn-primary" onclick="testGenerateText()">测试生成文本</button>
                <button class="btn btn-secondary" onclick="clearForm('text')">清空</button>

                <div id="message-text" class="message"></div>
                <div id="response-text" class="response"></div>
            </div>
        </div>
    </div>

    <script>
        let currentImages = {
            picture: null,
            text: null
        };

        // 切换端点
        function switchEndpoint(endpoint) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`endpoint-${endpoint}`).classList.add('active');
        }

        // 图片预览
        ['picture', 'text'].forEach(type => {
            document.getElementById(`image-${type}`).addEventListener('change', function(e) {
                handleImageUpload(e, type);
            });
        });

        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // 文件大小检查
            if (file.size > 10 * 1024 * 1024) {
                showMessage(type, '文件过大，最大支持10MB', 'error');
                return;
            }

            // 文件类型检查
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/heic'];
            if (!allowedTypes.includes(file.type.toLowerCase())) {
                showMessage(type, '不支持的文件格式', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // 显示预览
                const preview = document.getElementById(`preview-${type}`);
                preview.src = e.target.result;
                preview.style.display = 'block';

                // 安全地提取base64数据（移除data URI前缀）
                const base64Data = extractBase64FromDataUrl(e.target.result);
                
                if (base64Data) {
                    // 存储为对象，包含 mime_type 和 data
                    currentImages[type] = {
                        mime_type: file.type,
                        data: base64Data
                    };
                    console.log(`图片处理成功 (${type}):`, {
                        文件名: file.name,
                        文件类型: file.type,
                        文件大小: `${(file.size / 1024).toFixed(2)} KB`,
                        Base64长度: `${base64Data.length} 字符`,
                        Base64前缀: base64Data.substring(0, 50) + '...'
                    });
                    showMessage(type, `图片上传成功 (${(file.size / 1024).toFixed(2)} KB)`, 'success');
                } else {
                    showMessage(type, '图片处理失败，请重新上传', 'error');
                }
            };
            reader.onerror = function() {
                showMessage(type, '图片读取失败', 'error');
            };
            reader.readAsDataURL(file);
        }

        // 安全地从data URL中提取base64数据
        function extractBase64FromDataUrl(dataUrl) {
            try {
                const commaIndex = dataUrl.indexOf(',');
                if (commaIndex === -1) {
                    throw new Error('Invalid data URL format');
                }
                const base64String = dataUrl.substring(commaIndex + 1);
                
                if (!/^[A-Za-z0-9+/]*={0,2}$/.test(base64String)) {
                    throw new Error('Invalid base64 format');
                }
                
                return base64String;
            
            } catch (error) {
                console.error('Base64 extraction error:', error);
                return null;
            }
        }

        // 测试生成故事+配图
        async function testGeneratePicture() {
            const apiUrl = document.getElementById('api-url-picture').value.trim();
            const prompt = document.getElementById('prompt-picture').value.trim();
            const image = currentImages.picture;
            const language = document.getElementById('language-picture').value;
            const sessionId = document.getElementById('session-picture').value.trim();

            if (!apiUrl) {
                showMessage('picture', 'API地址不能为空', 'error');
                return;
            }

            if (!prompt && !image) {
                showMessage('picture', '请至少提供文本提示或上传图片', 'error');
                return;
            }

            if (image && !image) {
                showMessage('picture', '图片数据无效，请重新上传', 'error');
                return;
            }

            const requestBody = { language };
            if (prompt) requestBody.prompt = prompt;
if (image) {
    if (
        typeof image !== 'object' ||
        !image.data ||
        !image.mime_type
    ) {
        showMessage('picture', '图片数据格式错误，请重新上传', 'error');
        return;
    }
    requestBody.image = image;
}
            if (sessionId) requestBody.session_id = sessionId;

            console.log('请求数据:', {
                ...requestBody,
                image: image ? `[Base64数据 ${image.length} 字符]` : undefined
            });

            showMessage('picture', '正在生成故事和配图...', 'loading');

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    showMessage('picture', '生成成功！', 'success');
                    displayPictureResponse(data);
                    
                    if (data.session_id) {
                        document.getElementById('session-picture').value = data.session_id;
                    }
                } else {
                    showMessage('picture', `生成失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showMessage('picture', `请求失败: ${error.message}`, 'error');
            }
        }

        // 测试生成文本
        async function testGenerateText() {
            const apiUrl = document.getElementById('api-url-text').value.trim();
            const prompt = document.getElementById('prompt-text').value.trim();
            const image = currentImages.text;
            const language = document.getElementById('language-text').value;
            const sessionId = document.getElementById('session-text').value.trim();

            if (!apiUrl) {
                showMessage('text', 'API地址不能为空', 'error');
                return;
            }

            if (!prompt && !image) {
                showMessage('text', '请至少提供文本提示或上传图片', 'error');
                return;
            }

            if (image && !image) {
                showMessage('text', '图片数据无效，请重新上传', 'error');
                return;
            }

            const requestBody = { language };
            if (prompt) requestBody.prompt = prompt;
            if (image) {
                if (typeof image !== 'string' || image.length === 0) {
                    showMessage('text', '图片数据格式错误，请重新上传', 'error');
                    return;
                }
                requestBody.image = image;
            }
            if (sessionId) requestBody.session_id = sessionId;

            console.log('请求数据:', {
                ...requestBody,
                image: image ? `[Base64数据 ${image.length} 字符]` : undefined
            });

            showMessage('text', '正在生成故事文本...', 'loading');

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    showMessage('text', '生成成功！', 'success');
                    displayTextResponse(data);
                    
                    if (data.session_id) {
                        document.getElementById('session-text').value = data.session_id;
                    }
                } else {
                    showMessage('text', `生成失败: ${data.error || '未知错误'}`, 'error');
                    console.error('API错误响应:', data);
                }
            } catch (error) {
                showMessage('text', `请求失败: ${error.message}`, 'error');
                console.error('请求错误:', error);
            }
        }

        // 显示生成故事+配图的响应
        function displayPictureResponse(data) {
            const responseDiv = document.getElementById('response-picture');
            
            let html = `
                <h3>响应数据:</h3>
                <div><strong>会话ID:</strong> ${data.session_id}</div>
                <div><strong>成功状态:</strong> ${data.success}</div>
                
                <h4>故事内容 (Markdown):</h4>
                <div class="story-output">${renderMarkdown(data.data.story_markdown)}</div>
                
                <h4>配图:</h4>
            `;
            
            if (data.data.image_url) {
                html += `<img src="${data.data.image_url}" class="generated-image" alt="生成的配图">`;
            } else {
                html += `<div>未生成配图</div>`;
            }
            
            html += `
                <h4>完整JSON响应:</h4>
                <div class="json-output">${JSON.stringify(data, null, 2)}</div>
            `;
            
            responseDiv.innerHTML = html;
            responseDiv.style.display = 'block';
        }

        // 显示生成文本的响应
        function displayTextResponse(data) {
            const responseDiv = document.getElementById('response-text');
            
            const html = `
                <h3>响应数据:</h3>
                <div><strong>会话ID:</strong> ${data.session_id}</div>
                <div><strong>成功状态:</strong> ${data.success}</div>
                
                <h4>故事内容 (Markdown):</h4>
                <div class="story-output">${renderMarkdown(data.data.story_markdown)}</div>
                
                <h4>图片提示词:</h4>
                <div class="story-output">${data.data.image_prompt}</div>
                
                <h4>完整JSON响应:</h4>
                <div class="json-output">${JSON.stringify(data, null, 2)}</div>
            `;
            
            responseDiv.innerHTML = html;
            responseDiv.style.display = 'block';
        }

        // 简单的Markdown渲染
        function renderMarkdown(markdown) {
            return markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^\* (.*$)/gim, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(.+)$/gim, '<p>$1</p>')
                .replace(/<p><h/g, '<h')
                .replace(/<\/h([1-6])><\/p>/g, '<\/h$1>')
                .replace(/<p><li>/g, '<ul><li>')
                .replace(/<\/li><\/p>/g, '<\/li><\/ul>')
                .replace(/<\/ul>\s*<ul>/g, '');
        }

        // 显示消息
        function showMessage(type, text, messageType) {
            const messageDiv = document.getElementById(`message-${type}`);
            messageDiv.className = `message ${messageType}`;
            
            if (messageType === 'loading') {
                messageDiv.innerHTML = `<span class="spinner"></span>${text}`;
            } else {
                messageDiv.textContent = text;
            }
            
            messageDiv.style.display = 'block';
            
            if (messageType === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // 清空表单
        function clearForm(type) {
            document.getElementById(`prompt-${type}`).value = '';
            document.getElementById(`image-${type}`).value = '';
            document.getElementById(`session-${type}`).value = '';
            document.getElementById(`language-${type}`).value = 'zh';
            document.getElementById(`preview-${type}`).style.display = 'none';
            document.getElementById(`response-${type}`).style.display = 'none';
            document.getElementById(`message-${type}`).style.display = 'none';
            
            currentImages[type] = null;
            
            showMessage(type, '表单已清空', 'success');
        }
    </script>
</body>
</html>