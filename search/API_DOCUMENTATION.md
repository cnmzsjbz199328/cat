# **AI 故事生成器 API 文档 (最终版)**

## 1. 概述

本 API 服务旨在根据用户输入（文本提示或图片），生成一个**结构化的、使用 Markdown 格式的完整故事**，并为整个故事生成**一张最具代表性的配图**。

API 的设计遵循“关注点分离”的最佳实践：AI 被要求同时创作故事文本并为该故事提炼出一个最适合生成图片的“画面描述”，后端则使用这个专门的“画面描述”来确保图片质量，最终向用户呈现完整的故事和配图。

### 主要特性

*   **层次化内容输出**: 生成单一、完整的 Markdown 格式故事，支持标题、列表等，结构清晰。
*   **单一优质配图**: 每次调用只为整个故事生成一张最具代表性的图片，保证效率和图片质量。
*   **智能提示词**: AI 在创作故事的同时，会独立生成一个最适合图片模型的、经过优化的提示词 (`image_prompt`)。
*   **多模态输入**: 支持纯文本、纯图片或图文混合输入。
*   **会话保持**: 通过 `session_id` 实现上下文感知，可以进行多轮对话，让故事得以延续。
*   **多语言支持**: 支持中文（默认）、英文和日文。

## 2. 通用概念

### 2.1 请求与响应格式

*   所有 `POST` 请求的 `Content-Type` 必须为 `application/json`。
*   **成功响应 (200 OK)** 的结构为 `{ "success": true, "data": { ... }, "session_id": "..." }`。
*   **失败响应** 的结构为 `{ "success": false, "error": "错误信息描述" }`。

### 2.2 会话管理 (`session_id`)

API 通过 `session_id` 来维持对话的上下文，会话数据在服务器上保留 24 小时。

*   **首次请求**: 无需提供 `session_id`。API 会自动创建一个新会话，并在响应中返回一个 `session_id`。
*   **后续请求**: 请在请求体中附带上一次响应中获取的 `session_id`，以便 API 能够理解上下文，并在此基础上继续创作。

## 3. API 端点 (Endpoints)

---

### **`/api/generate-story`**

此端点是核心功能接口，用于生成 Markdown 故事**并**为其生成一张配图。这是一个完整的、端到端的调用。

*   **Method**: `POST`

#### 请求体 (Request Body)

| 参数 | 类型 | 是否必需 | 描述 |
| :--- | :--- | :--- | :--- |
| `prompt` | String | 条件性 | 用户的文本提示。`prompt` 和 `image` 至少需要提供一个。 |
| `image` | String | 条件性 | Base64 编码的图片数据（不包含 `data:image/...;base64,` 前缀）。 |
| `language` | String | 可选 | 输出语言。支持的值：`'zh'` (中文，默认), `'en'` (英文), `'ja'` (日文)。 |
| `session_id`| String | 可选 | 会话 ID。用于保持对话上下文。 |

**请求示例:**
```json
{
    "prompt": "给我讲一个关于小狗在森林里探险的故事",
    "language": "zh"
}
```

#### 成功响应 (200 OK)

**`data` 对象的结构:**
| 键 | 类型 | 描述 |
| :--- | :--- | :--- |
| `story_markdown` | String | 一个使用 Markdown 语法格式化的、完整的、有层次的故事文本。 |
| `image_url` | String / `null` | 根据 AI 生成的内部 `image_prompt` 所生成的图片 URL。如果失败则为 `null`。 |

**响应示例:**
```json
{
    "success": true,
    "data": {
        "story_markdown": "# 森林里的小狗探险记\n\n## 启程\n\n在森林边缘的小屋里，住着一只名叫多多的小狗。多多是一只雪白的小比熊，拥有一双充满好奇的黑眼睛。每天，它都会在院子里玩耍，但那片深邃而神秘的森林，总是让它心生向往。大人们常说森林里有许多未知和危险，但多多心底的冒险之火却越燃越旺。\n\n## 初探秘境\n\n一个阳光明媚的午后，多多趁着大人们不注意，偷偷溜进了森林。森林里的空气清新而湿润，泥土的气息、树木的芬芳交织在一起，让多多兴奋不已。它摇着尾巴，迈着轻快的步伐，开始了自己的探险。\n\n*   **追逐蝴蝶**：一只色彩斑斓的蝴蝶在花丛中翩翩起舞，多多立刻被吸引，摇摇晃晃地追逐起来，不小心撞进了一丛灌木，惹得一片叶子上的露珠洒了它一身。\n*   **偶遇松鼠**：不远处，一只小松鼠正抱着一颗橡子坐在树枝上。多多好奇地凑过去，松鼠警惕地看了它一眼，然后“吱吱”叫了两声，飞快地爬上了更高的树枝，留下多多独自在树下歪着头，疑惑地嗅了嗅。\n*   **聆听鸟鸣**：各种鸟儿的歌声此起彼伏，清脆悦耳。多多停下脚步，仰着头，仔细聆听着这大自然的交响乐，一时间忘记了所有，沉浸在这美妙的旋律中。\n\n## 迷失与指引\n\n多多走得太远，不知不觉间，阳光透过树叶变得稀疏，森林深处的光线越来越暗。它突然感到一丝不安，周围的树木看起来都一样，它找不到回家的路了。小狗开始有些害怕，它试探性地叫了两声，声音在寂静的森林里显得格外渺小。\n\n就在多多焦急万分的时候，头顶上传来一声悠长的“咕——咕——”声。多多抬头望去，只见一只羽毛斑驳的老猫头鹰，正站在一棵古老的橡树枝头，用它那双睿智的眼睛看着它。猫头鹰轻轻扇动了一下翅膀，然后朝着一个方向飞去，飞了几米后又停下，似乎在示意多多跟上。\n\n多多犹豫了一下，但心中的恐惧让它别无选择。它紧紧跟着猫头鹰，穿过一片长满蕨类植物的小径，越过一条清澈的小溪。\n\n## 归途与成长\n\n在老猫头鹰的指引下，多多渐渐听到了远处熟悉的风吹过屋顶的声音，闻到了家园特有的柴火味。当它看到院子的篱笆时，兴奋地加快了脚步。它带着一身的泥土和树叶，回到了温暖的家。\n\n虽然有些狼狈，但多多的眼神里充满了经历过冒险的满足和喜悦。这次森林探险让它明白，外面世界充满精彩，但也需要勇气和智慧。多多知道，这只是它冒险旅程的开始，未来的日子，它还会继续探索这片充满奥秘的森林，但下一次，它会更加小心和聪明。",
        "image_url": "https://aigc-files.bigmodel.cn/api/cogview/2025072708292668d9bece51804ade_0.png"
    },
    "session_id": "session_1753576155431_2lt5ehqk0"
}
```

---

### **`/api/generate-text`**

此端点用于**仅生成文本内容**，不执行实际的图片生成。它速度更快，适用于调试或仅需文本的场景。它会返回故事的 Markdown 和 AI 用于生成图片的**内部提示词 (`image_prompt`)**。

*   **Method**: `POST`

#### 请求体 (Request Body)

与 `/api/generate-story` 的请求体完全相同。

#### 成功响应 (200 OK)

**`data` 对象的结构:**
| 键 | 类型 | 描述 |
| :--- | :--- | :--- |
| `story_markdown` | String | 一个使用 Markdown 语法格式化的、完整的、有层次的故事文本。 |
| `image_prompt` | String | AI 基于整个故事提炼出的、最适合生成一张图片的**画面描述**。 |

**响应示例:**
```json
{
    "success": true,
    "data": {
        "story_markdown": "# 小狐狸的森林探险\n\n在一片茂密的森林深处，住着一只名叫小福的、毛色火红的小狐狸。小福天生好奇，总是对森林里那些未知的角落充满向往。\n\n## 踏上旅途\n\n一天清晨，当露珠还在草尖上闪烁时，小福决定独自踏上一段探险之旅。它沿着一条平时从未走过的小径，小心翼翼地深入森林。阳光透过树叶的缝隙洒下来，在地上形成斑驳的光影。小福蹦蹦跳跳地走着，它的鼻子不停地嗅着空气中各种新奇的味道。\n\n## 遇到的新奇事物\n\n它首先遇到了一棵巨大的、看起来已经活了上千年的老橡树。橡树的树干粗壮得像一座小山，树洞里似乎藏着许多秘密。小福好奇地探头进去，发现里面住着一群忙碌的小松鼠，它们正吱吱喳喳地搬运着松果。小福蹲在一旁，津津有味地看着它们，觉得非常有趣。\n\n接着，小福来到了一条清澈的小溪边。溪水潺潺流淌，水底的鹅卵石清晰可见。小福小心翼翼地伸出爪子，试探性地拨弄着水面。突然，一条色彩斑斓的小鱼从水底游过，吓了小福一跳，它咯咯地笑了起来。\n\n## 克服困难\n\n就在小福沉浸在美景中时，它发现自己迷路了。周围的树木看起来都一模一样，阳光也渐渐被茂密的树冠遮挡住。小福的心跳开始加速，它有点害怕了。就在这时，它听到了一阵轻柔的呼唤声。\n\n原来是一只年迈的猫头鹰奶奶，它正停在一棵高大的树枝上。猫头鹰奶奶慈祥地看着小福，用沙哑的声音说：“小狐狸，迷路了吗？记住，森林里总有指引。仔细听，风会告诉你方向；仔细看，苔藓永远朝北生长。”\n\n小福按照猫头鹰奶奶的指点，仔细观察周围的环境。它发现树干北面的苔藓确实更加茂盛。它又闭上眼睛，感受风吹来的方向。渐渐地，一个清晰的路线在它脑海中浮现。\n\n## 满载而归\n\n最终，小福成功地找到了回家的路。当它回到熟悉的狐狸洞时，夕阳已经染红了半边天。小福虽然有些疲惫，但它的心中充满了喜悦和自豪。这次探险让它认识了新朋友，学到了新知识，更重要的是，它学会了如何勇敢地面对困难。从那以后，小福变得更加自信，也更加热爱这片充满奇迹的森林。",
        "image_prompt": "一只好奇的小红狐狸在阳光斑驳、郁郁葱葱的森林中探索，它遇到了古老的橡树和清澈的溪流，并在智慧猫头鹰的指引下，最终充满自信地回家。"
    },
    "session_id": "session_1753576119338_7y0linji5"
}```